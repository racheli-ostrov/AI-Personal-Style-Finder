name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Backend tests and build (Python)
  backend:
    name: Backend - Test & Build (Python)
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./backend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: backend/requirements.txt
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests with coverage
      run: pytest
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        files: ./backend/htmlcov/coverage.xml
        flags: backend
        name: backend-coverage
    
    - name: Build Docker image
      run: docker build -t style-finder-backend:${{ github.sha }} .
    
    - name: Save Docker image
      run: docker save style-finder-backend:${{ github.sha }} | gzip > backend-image.tar.gz
    
    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: backend-image
        path: backend/backend-image.tar.gz
        retention-days: 1

  # Frontend tests and build
  frontend:
    name: Frontend - Test & Build
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: npm install --legacy-peer-deps
    
    - name: Run tests with coverage
      run: npm test -- --coverage --watchAll=false
      env:
        CI: true
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        files: ./frontend/coverage/coverage-final.json
        flags: frontend
        name: frontend-coverage
    
    - name: Build application
      run: npm run build
      env:
        REACT_APP_API_URL: http://localhost:5001/api
    
    - name: Build Docker image
      run: docker build -t style-finder-frontend:${{ github.sha }} .
    
    - name: Save Docker image
      run: docker save style-finder-frontend:${{ github.sha }} | gzip > frontend-image.tar.gz
    
    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: frontend-image
        path: frontend/frontend-image.tar.gz
        retention-days: 1

  # Integration test with Docker Compose
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download backend image
      uses: actions/download-artifact@v4
      with:
        name: backend-image
    
    - name: Download frontend image
      uses: actions/download-artifact@v4
      with:
        name: frontend-image
    
    - name: Load Docker images
      run: |
        docker load < backend-image.tar.gz
        docker load < frontend-image.tar.gz
    
    - name: Tag images for compose
      run: |
        docker tag style-finder-backend:${{ github.sha }} style-finder-backend:latest
        docker tag style-finder-frontend:${{ github.sha }} style-finder-frontend:latest
    
    - name: Start services with Docker Compose
      run: docker compose up -d
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
    
    - name: Wait for services to be healthy
      run: |
        timeout 120 bash -c 'until docker compose ps | grep -q "healthy"; do sleep 2; done'
    
    - name: Wait for backend to be ready
      run: |
        for i in {1..30}; do
          if curl -f http://localhost:3000/api/health; then
            echo "Backend is up!"; exit 0;
          fi
          echo "Waiting for backend..."; sleep 5;
        done
        echo "Backend did not start in time"; exit 1
    
    - name: Check frontend availability
      run: curl -f http://localhost:3000 || exit 1
    
    - name: Show logs on failure
      if: failure()
      run: docker compose logs
    
    - name: Stop services
      if: always()
      run: docker compose down

  # Deploy stage (optional - for production)
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [integration]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download backend image
      uses: actions/download-artifact@v4
      with:
        name: backend-image
    
    - name: Download frontend image
      uses: actions/download-artifact@v4
      with:
        name: frontend-image
    
    - name: Load Docker images
      run: |
        docker load < backend-image.tar.gz
        docker load < frontend-image.tar.gz
    
    # Add your deployment steps here
    # Examples:
    # - Push to Docker Hub / AWS ECR / Google Container Registry
    # - Deploy to Kubernetes / AWS ECS / Azure Container Apps
    # - Update cloud services
    
    - name: Deployment placeholder
      run: |
        echo "ðŸš€ Deployment step"
        echo "Add your deployment commands here"
        echo "Examples: docker push, kubectl apply, aws ecs update-service, etc."
